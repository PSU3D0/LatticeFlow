{
  "$id": "https://lattice.dev/schemas/flow_ir.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "definitions": {
    "ArtifactRef": {
      "description": "Artifact reference bundled alongside Flow IR.",
      "properties": {
        "format": {
          "description": "Optional format identifier.",
          "type": [
            "string",
            "null"
          ]
        },
        "kind": {
          "description": "Artifact kind (dot, wit, json-schema, etc.).",
          "type": "string"
        },
        "path": {
          "description": "Relative path to the artifact.",
          "type": "string"
        }
      },
      "required": [
        "kind",
        "path"
      ],
      "type": "object"
    },
    "BufferPolicy": {
      "description": "Buffering behaviour metadata.",
      "properties": {
        "max_items": {
          "description": "Optional max items held in memory.",
          "format": "uint32",
          "minimum": 0.0,
          "type": [
            "integer",
            "null"
          ]
        },
        "on_drop": {
          "description": "Drop behaviour description.",
          "type": [
            "string",
            "null"
          ]
        },
        "spill_threshold_bytes": {
          "description": "Optional spill threshold in bytes.",
          "format": "uint64",
          "minimum": 0.0,
          "type": [
            "integer",
            "null"
          ]
        },
        "spill_tier": {
          "description": "Optional spill tier identifier.",
          "type": [
            "string",
            "null"
          ]
        }
      },
      "type": "object"
    },
    "CheckpointIR": {
      "description": "Checkpoint definition.",
      "properties": {
        "id": {
          "description": "Checkpoint identifier.",
          "type": "string"
        },
        "summary": {
          "description": "Optional summary.",
          "type": [
            "string",
            "null"
          ]
        }
      },
      "required": [
        "id"
      ],
      "type": "object"
    },
    "ControlSurfaceIR": {
      "description": "Control surface metadata for branching/looping constructs.",
      "properties": {
        "config": {
          "description": "JSON payload describing surface-specific configuration."
        },
        "id": {
          "description": "Stable identifier for the control surface.",
          "type": "string"
        },
        "kind": {
          "allOf": [
            {
              "$ref": "#/definitions/ControlSurfaceKind"
            }
          ],
          "description": "Control surface type."
        },
        "targets": {
          "description": "Target node/edge aliases.",
          "items": {
            "type": "string"
          },
          "type": "array"
        }
      },
      "required": [
        "id",
        "kind",
        "targets"
      ],
      "type": "object"
    },
    "ControlSurfaceKind": {
      "description": "Supported control surface variants.",
      "oneOf": [
        {
          "description": "Switch/multi-branch control flow.",
          "enum": [
            "switch"
          ],
          "type": "string"
        },
        {
          "description": "Binary branching (if).",
          "enum": [
            "if"
          ],
          "type": "string"
        },
        {
          "description": "Loop construct.",
          "enum": [
            "loop"
          ],
          "type": "string"
        },
        {
          "description": "For-each iteration construct.",
          "enum": [
            "for_each"
          ],
          "type": "string"
        },
        {
          "description": "Windowing configuration.",
          "enum": [
            "window"
          ],
          "type": "string"
        },
        {
          "description": "Partition description.",
          "enum": [
            "partition"
          ],
          "type": "string"
        },
        {
          "description": "Timeout/latency guard.",
          "enum": [
            "timeout"
          ],
          "type": "string"
        },
        {
          "description": "Rate limit guard.",
          "enum": [
            "rate_limit"
          ],
          "type": "string"
        },
        {
          "description": "Error-handling surface.",
          "enum": [
            "error_handler"
          ],
          "type": "string"
        }
      ]
    },
    "Delivery": {
      "description": "Delivery semantics enumeration.",
      "oneOf": [
        {
          "description": "At least once delivery (default).",
          "enum": [
            "at_least_once"
          ],
          "type": "string"
        },
        {
          "description": "At most once delivery.",
          "enum": [
            "at_most_once"
          ],
          "type": "string"
        },
        {
          "description": "Exactly once delivery (requires dedupe).",
          "enum": [
            "exactly_once"
          ],
          "type": "string"
        }
      ]
    },
    "Determinism": {
      "description": "Determinism lattice describing replay guarantees.",
      "oneOf": [
        {
          "description": "Fully deterministic, no time or randomness.",
          "enum": [
            "strict"
          ],
          "type": "string"
        },
        {
          "description": "Stable under pinned resources.",
          "enum": [
            "stable"
          ],
          "type": "string"
        },
        {
          "description": "Best-effort determinism, may vary on retries.",
          "enum": [
            "best_effort"
          ],
          "type": "string"
        },
        {
          "description": "Explicitly non-deterministic.",
          "enum": [
            "nondeterministic"
          ],
          "type": "string"
        }
      ]
    },
    "EdgeIR": {
      "description": "Edge entry within the Flow IR.",
      "properties": {
        "buffer": {
          "allOf": [
            {
              "$ref": "#/definitions/BufferPolicy"
            }
          ],
          "description": "Buffer policy."
        },
        "delivery": {
          "allOf": [
            {
              "$ref": "#/definitions/Delivery"
            }
          ],
          "description": "Delivery semantics."
        },
        "from": {
          "description": "Source node alias.",
          "type": "string"
        },
        "ordering": {
          "allOf": [
            {
              "$ref": "#/definitions/Ordering"
            }
          ],
          "description": "Ordering semantics."
        },
        "partition_key": {
          "description": "Optional partition key expression.",
          "type": [
            "string",
            "null"
          ]
        },
        "timeout_ms": {
          "description": "Optional timeout in milliseconds.",
          "format": "uint64",
          "minimum": 0.0,
          "type": [
            "integer",
            "null"
          ]
        },
        "to": {
          "description": "Destination node alias.",
          "type": "string"
        }
      },
      "required": [
        "buffer",
        "delivery",
        "from",
        "ordering",
        "to"
      ],
      "type": "object"
    },
    "Effects": {
      "description": "Effect lattice describing resource access.",
      "oneOf": [
        {
          "description": "No observable side-effects.",
          "enum": [
            "pure"
          ],
          "type": "string"
        },
        {
          "description": "Read-only side-effects (e.g. cache lookups).",
          "enum": [
            "read_only"
          ],
          "type": "string"
        },
        {
          "description": "External side-effects (e.g. network, writes).",
          "enum": [
            "effectful"
          ],
          "type": "string"
        }
      ]
    },
    "FlowMetadata": {
      "description": "Arbitrary metadata describing the workflow.",
      "properties": {
        "tags": {
          "default": [],
          "description": "Optional tags associated with the workflow.",
          "items": {
            "type": "string"
          },
          "type": "array"
        }
      },
      "type": "object"
    },
    "FlowPolicies": {
      "description": "Policy lint configuration.",
      "properties": {
        "lint": {
          "allOf": [
            {
              "$ref": "#/definitions/PolicyLintSettings"
            }
          ],
          "default": {
            "require_control_hints": false
          },
          "description": "Lint configuration."
        }
      },
      "type": "object"
    },
    "IdempotencyScope": {
      "description": "Supported idempotency scopes.",
      "oneOf": [
        {
          "description": "Key applies to a specific node.",
          "enum": [
            "node"
          ],
          "type": "string"
        },
        {
          "description": "Key applies to a specific edge.",
          "enum": [
            "edge"
          ],
          "type": "string"
        },
        {
          "description": "Key applies to a partition.",
          "enum": [
            "partition"
          ],
          "type": "string"
        }
      ]
    },
    "IdempotencySpec": {
      "description": "Idempotency metadata for a node.",
      "properties": {
        "key": {
          "description": "Canonical idempotency key expression.",
          "type": [
            "string",
            "null"
          ]
        },
        "scope": {
          "anyOf": [
            {
              "$ref": "#/definitions/IdempotencyScope"
            },
            {
              "type": "null"
            }
          ],
          "description": "Scope for the idempotency key."
        },
        "ttlMs": {
          "description": "Optional TTL (in milliseconds) for dedupe reservations.",
          "format": "uint64",
          "minimum": 0.0,
          "type": [
            "integer",
            "null"
          ]
        }
      },
      "type": "object"
    },
    "NodeIR": {
      "description": "Node entry within the Flow IR.",
      "properties": {
        "alias": {
          "description": "Alias used within the workflow definition.",
          "type": "string"
        },
        "determinism": {
          "allOf": [
            {
              "$ref": "#/definitions/Determinism"
            }
          ],
          "description": "Declared determinism metadata."
        },
        "determinismHints": {
          "default": [],
          "description": "Determinism hints recorded during macro expansion.",
          "items": {
            "type": "string"
          },
          "type": "array"
        },
        "effectHints": {
          "default": [],
          "description": "Effect hints recorded during macro expansion.",
          "items": {
            "type": "string"
          },
          "type": "array"
        },
        "effects": {
          "allOf": [
            {
              "$ref": "#/definitions/Effects"
            }
          ],
          "description": "Declared effects metadata."
        },
        "id": {
          "description": "Stable identifier derived from the spec.",
          "type": "string"
        },
        "idempotency": {
          "allOf": [
            {
              "$ref": "#/definitions/IdempotencySpec"
            }
          ],
          "default": {},
          "description": "Optional idempotency configuration."
        },
        "identifier": {
          "description": "Fully-qualified implementation identifier used for runtime lookup.",
          "type": "string"
        },
        "in_schema": {
          "allOf": [
            {
              "$ref": "#/definitions/SchemaRef"
            }
          ],
          "description": "Input schema reference."
        },
        "kind": {
          "allOf": [
            {
              "$ref": "#/definitions/NodeKind"
            }
          ],
          "description": "Node kind."
        },
        "name": {
          "description": "Human readable name.",
          "type": "string"
        },
        "out_schema": {
          "allOf": [
            {
              "$ref": "#/definitions/SchemaRef"
            }
          ],
          "description": "Output schema reference."
        },
        "summary": {
          "description": "Optional summary/description.",
          "type": [
            "string",
            "null"
          ]
        }
      },
      "required": [
        "alias",
        "determinism",
        "effects",
        "id",
        "identifier",
        "in_schema",
        "kind",
        "name",
        "out_schema"
      ],
      "type": "object"
    },
    "NodeKind": {
      "description": "High-level node categories.",
      "oneOf": [
        {
          "description": "Trigger originating the workflow.",
          "enum": [
            "trigger"
          ],
          "type": "string"
        },
        {
          "description": "Inline rust node.",
          "enum": [
            "inline"
          ],
          "type": "string"
        },
        {
          "description": "Activity/connector node.",
          "enum": [
            "activity"
          ],
          "type": "string"
        },
        {
          "description": "Subflow invocation.",
          "enum": [
            "subflow"
          ],
          "type": "string"
        }
      ]
    },
    "Ordering": {
      "description": "Edge ordering semantics.",
      "oneOf": [
        {
          "description": "FIFO semantics per partition.",
          "enum": [
            "ordered"
          ],
          "type": "string"
        },
        {
          "description": "No ordering guarantees.",
          "enum": [
            "unordered"
          ],
          "type": "string"
        }
      ]
    },
    "PolicyLintSettings": {
      "description": "Lint-specific policy settings.",
      "properties": {
        "require_control_hints": {
          "description": "Whether control surface hints are required.",
          "type": "boolean"
        }
      },
      "required": [
        "require_control_hints"
      ],
      "type": "object"
    },
    "Profile": {
      "description": "Workflow execution profile.",
      "oneOf": [
        {
          "description": "HTTP/Axum host.",
          "enum": [
            "web"
          ],
          "type": "string"
        },
        {
          "description": "Queue/Redis-backed workers.",
          "enum": [
            "queue"
          ],
          "type": "string"
        },
        {
          "description": "Temporal orchestration.",
          "enum": [
            "temporal"
          ],
          "type": "string"
        },
        {
          "description": "WASM/Edge runtime.",
          "enum": [
            "wasm"
          ],
          "type": "string"
        },
        {
          "description": "Local developer profile.",
          "enum": [
            "dev"
          ],
          "type": "string"
        }
      ]
    },
    "SchemaRef": {
      "description": "Schema reference used within Flow IR.",
      "oneOf": [
        {
          "description": "Schema is opaque/unknown.",
          "properties": {
            "kind": {
              "enum": [
                "opaque"
              ],
              "type": "string"
            }
          },
          "required": [
            "kind"
          ],
          "type": "object"
        },
        {
          "description": "Strongly named schema reference.",
          "properties": {
            "kind": {
              "enum": [
                "named"
              ],
              "type": "string"
            },
            "name": {
              "type": "string"
            }
          },
          "required": [
            "kind",
            "name"
          ],
          "type": "object"
        }
      ]
    }
  },
  "description": "Canonical, host-agnostic representation for workflows emitted by the Lattice Rust macro DSL.",
  "properties": {
    "artifacts": {
      "default": [],
      "description": "Associated artifact references (DOT, WIT, etc.).",
      "items": {
        "$ref": "#/definitions/ArtifactRef"
      },
      "type": "array"
    },
    "checkpoints": {
      "default": [],
      "description": "Declared checkpoints.",
      "items": {
        "$ref": "#/definitions/CheckpointIR"
      },
      "type": "array"
    },
    "control_surfaces": {
      "default": [],
      "description": "Control surface metadata (branching/loops/etc).",
      "items": {
        "$ref": "#/definitions/ControlSurfaceIR"
      },
      "type": "array"
    },
    "edges": {
      "default": [],
      "description": "Edges describing the DAG.",
      "items": {
        "$ref": "#/definitions/EdgeIR"
      },
      "type": "array"
    },
    "id": {
      "description": "Unique workflow identifier.",
      "type": "string"
    },
    "metadata": {
      "allOf": [
        {
          "$ref": "#/definitions/FlowMetadata"
        }
      ],
      "default": {
        "tags": []
      },
      "description": "Documentation and tag metadata."
    },
    "name": {
      "description": "Workflow display name.",
      "type": "string"
    },
    "nodes": {
      "default": [],
      "description": "Nodes contained in the workflow.",
      "items": {
        "$ref": "#/definitions/NodeIR"
      },
      "type": "array"
    },
    "policies": {
      "allOf": [
        {
          "$ref": "#/definitions/FlowPolicies"
        }
      ],
      "default": {
        "lint": {
          "require_control_hints": false
        }
      },
      "description": "Policy metadata."
    },
    "profile": {
      "allOf": [
        {
          "$ref": "#/definitions/Profile"
        }
      ],
      "description": "Target profile."
    },
    "summary": {
      "description": "Optional human readable summary.",
      "type": [
        "string",
        "null"
      ]
    },
    "version": {
      "description": "Semantic version.",
      "type": "string"
    }
  },
  "required": [
    "id",
    "name",
    "profile",
    "version"
  ],
  "title": "Lattice Flow IR",
  "type": "object"
}
