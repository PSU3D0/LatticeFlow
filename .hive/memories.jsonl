{"id":"mem-0c46810972a798f1","information":"workflow_bundle! entrypoint parsing expects braces inside macro tokens; using `entrypoint!({ ... })` avoids `expected curly braces` errors when embedding in modules or other contexts. Also workflow_bundle! register paths require *_register functions to be in scope when using module wrapper.","created_at":"2026-01-27T00:51:43.703Z","tags":"workflow_bundle,dag-macros,entrypoint,register,examples"}
{"id":"mem-11d4dde80db9e9ec","information":"E3/E4 verification: agents-mcp store/tooling lacks SessionSummary aggregation, context_summary table, MCP session.list, and A2A sessions/list extension; no migrations found for context_summary. ACP adapter exists (acp_server.rs) with initialize/new_session/prompt, runtime config wiring, metadata persistence for mcp servers/cwd/permission options. Gaps: no session_id->context_id mapping persistence or history aggregation across runs; ACP event bridge only handles tool call start/complete/fail + run failed (no model/run completion/approval pending); ACP permission flow issues request_permission but does not persist decisions or wire to ApprovalHook record_approval; no ACP proxy chain config/capability.","created_at":"2026-01-27T01:00:24.655Z","tags":"agents-rs,E3,E4,acp,session-listing,context-summary,approval,events"}
{"id":"mem-1be1955ff29d5682","information":"FlowBundle::executor in host-inproc downcasts Arc<dyn NodeResolver> (NodeResolver: Any) to Arc<NodeRegistry> to construct FlowExecutor; allows NodeRegistry to serve as resolver while keeping FlowBundle generic.","created_at":"2026-01-27T00:29:34.962Z","tags":"host-inproc,flowbundle,noderesolver,flowexecutor"}
{"id":"mem-263954c03056cf60","information":"agents-rs ticket review completed: 32 tickets across 8 epics (E1-E8) drafted and verified against codebase. Key findings: E6 (MCP Tool Surface) is complete, E5-T2/E5-T4/E7-T1/E7-T2 are done, E1-E4 and E8 are mostly not_started. Coherency report in agents-rs/docs/tickets/COHERENCY_REPORT.md shows proper sequencing: E1 foundation -> E2-T3 metadata envelope -> E2-T1/T2 hydration -> E5 storage -> E3 session listing -> E8 artifacts -> E4 ACP. Cross-epic dependencies were tightened to ticket-level granularity.","created_at":"2026-01-27T01:02:16.042Z","tags":"agents-rs,ticket-planning,epic-decomposition,coordination"}
{"id":"mem-27c37d0dfa084fc4","information":"OpenCode ESC key behavior: SessionStatus only has 3 types (idle, busy, retry) - there is NO dedicated \"interrupted\" or \"cancelled\" status. To detect ESC-interrupt vs natural completion: check the last assistant message's error field. ESC-interrupt sets message.error.name = \"MessageAbortedError\", while natural completion has message.error = undefined and message.finish = \"stop\". ESC requires TWO presses within 5 seconds to actually abort. The smart-voice-notify plugin logs sessionData.status but has NO guards - all session.idle events trigger notifications regardless of whether user pressed ESC.","created_at":"2026-01-27T16:35:36.110Z","tags":"opencode,ESC,interrupt,session-status,smart-voice-notify,MessageAbortedError"}
{"id":"mem-2fd95fd775eadb47","information":"Exposed kernel-exec NodeHandler trait and NodeRegistry::handler as public to allow host-inproc NodeResolver to return Arc<dyn NodeHandler>.","created_at":"2026-01-27T00:23:26.550Z","tags":"kernel-exec,nodehandler,visibility,host-inproc"}
{"id":"mem-312fc49288f1c1be","information":"E1 investigation: RunStore only exposes list_runs with no ordering guarantees; FileSystemRunStore/SqlxRunStore enumerate run summaries without chronological sort. a2a-server run creation seeds messages only from context_pack (inherit/share) and does not load prior runs by context_id. SessionPolicy currently applies per-run events only. agents-mcp TaskStore has contexts table (client_session_id) but no binding logic for mcp_session_id -> context_id.","created_at":"2026-01-27T00:50:12.141Z","tags":"E1,context_id,RunStore,SessionPolicy,a2a-server,agents-mcp"}
{"id":"mem-3b0608cf0c71c02a","information":"E7 streaming + notifications are already implemented in agents-rs: A2A client has open_message_stream/open_task_stream/open_task_resubscribe in agents-mcp/src/a2a/client.rs; server/tools/mod.rs consumes SSE in send_message and await, forwarding events via StreamNotifier; StreamNotifier in server/tools/helpers.rs emits MCP logging and progress notifications. Push notifications are explicitly deferred in TECHNICAL_DESIGN.md; map_a2a_remote_error handles push-not-supported code.","created_at":"2026-01-27T00:49:17.510Z","tags":"agents-rs,E7,streaming,notifications,a2a,mcp,design"}
{"id":"mem-4762a7667c5eaaa6","information":"Implemented cross-session audio locking for opencode-smart-voice-notify using proper-lockfile with custom lockfilePath (/tmp/opencode-audio.lock). Lock target file is /tmp/opencode-audio (created if missing), stale=60s, update=5s; tryWithAudioLock used in tts playAudioFile to skip when locked.","created_at":"2026-01-27T18:04:49.546Z","tags":"opencode,smart-voice-notify,proper-lockfile,audio-lock,tts"}
{"id":"mem-494ccad03a95e5b3","information":"E2 investigation: A2A runtime already calls RunRepository::rebuild when a task is missing in resume/get/cancel, but stream_task still requires in-memory runs and stream buffer is not hydrated. ACP runtime rebuilds sessions via AcpAgent::get_session when repository is configured; build_session_from_run hydrates acp_cwd and acp_mcp_servers, permission options read from run metadata; tests exist for rehydration and pending-run handling. Kernel RunEvent/ContentPart currently lack metadata fields; Run.metadata and Message.metadata exist and A2A mapping reads protocols.a2a with fallback to a2a.","created_at":"2026-01-27T00:49:44.674Z","tags":"E2,hydration,a2a,acp,runrepository,metadata"}
{"id":"mem-4a91465b88f70f11","information":"Analyzed agents-rs tickets E1-E8 + COHERENCY_REPORT: key cross-epic deps include E2-T1/T2/T4 on E2-T3 (metadata envelope); E3-T1 on E1-T1/E1-T2/E2-T1; E3-T2 on E5-T5; E4-T1 on E2-T2/E2-T3/E5-T1; E4-T2 on E1-T1/E1-T2/E1-T3/E2-T2/E2-T3/E8-T3; E4-T3/T4 on E4-T1+E2-T3; E4-T5 on E4-T1+E2-T3+E5-T1; E8-T1 on E1-T1/E1-T2/E2-T3; E8-T2 on E1-T1/E1-T2/E2-T3/E5-T3/E8-T1; E8-T3 on E1-T2/E1-T3/E2-T3. Suggested sequence: E1 core -> E2-T3 -> E2-T1/T2 -> E5-T1/T3 -> E3 -> E8 -> E4. E5-T2/T4, E6, E7 already done.","created_at":"2026-01-27T18:09:08.689Z","tags":"agents-rs,dependency-graph,planning,epics"}
{"id":"mem-51ab460fe7e9e83b","information":"Implemented workflow_bundle macro parsing entrypoint! blocks (trigger/capture/route/method as string literals, deadline_ms as u64) and deriving register paths by replacing `_node_spec` with `_register` while preserving any module path prefix in bindings.","created_at":"2026-01-27T00:42:40.405Z","tags":"dag-macros,workflow_bundle,entrypoint,register"}
{"id":"mem-620c37850e76bee8","information":"CLI load_example now consumes FlowBundle entrypoint metadata; entrypoint.method is parsed as HTTP Method with POST default and invalid strings cause an error. route_path defaults to \"/\" when missing.","created_at":"2026-01-27T00:57:17.237Z","tags":"flows-cli flowbundle entrypoint method route_path"}
{"id":"mem-668ccd2c13ffafc2","information":"workflow_bundle! generated bundle() validates the macro-generated flow() before returning; if you need to mutate FlowIR (e.g., add idempotency for effectful nodes), avoid calling bundle_def::bundle() and construct FlowBundle manually with your adjusted flow/validated_ir plus registry/entrypoints/node_contracts.","created_at":"2026-01-27T06:52:16.413Z","tags":"lattice-flow workflow_bundle flowbundle idempotency tests"}
{"id":"mem-69cfaff4cee14066","information":"E3 Session Listing + Pagination tickets drafted with SessionSummary schema and cursor semantics from KERNEL_CENTRIC_PROTOCOL_DERIVATION_PLAN.md, aligned with A2A ListTasks page_size (1..100) and next_page_token empty-string rule from a2a.proto.","created_at":"2026-01-27T00:48:42.888Z","tags":"agents-rs,E3,session-listing,pagination,a2a,mcp,tickets"}
{"id":"mem-6df4a64fac66f78c","information":"E5 storage consolidation status: SQLx EventStore/RunStore implemented in agents-rs/crates/kernel/src/storage_sqlx.rs with run_events/run_snapshots/run_summaries; filesystem EventStore/RunStore/BlobStore implemented in agents-rs/crates/kernel/src/storage_fs.rs. SQLx BlobStore and pagination indexes still outstanding; no StorageBackend config/factory yet.","created_at":"2026-01-27T00:48:46.466Z","tags":"E5 storage backend consolidation sqlx filesystem blobstore pagination"}
{"id":"mem-74aa5f3ffbff664b","information":"Running `bun test` in dotfiles repo fails with many missing dependencies (e.g., @playwright/test, zod, remeda, aws4fetch, solid-js). Likely need install deps or scoped test run.","created_at":"2026-01-27T16:40:06.189Z","tags":"tests,bun,dependencies,opencode"}
{"id":"mem-74e8bc9c2e55eba6","information":"Added helper in rich-context.js to select last substantial assistant message (min length default 200) and added coordinator prompt filtering via patterns (IDENTITY/TASK/CONTEXT markers, swarm agent text). fetchContext now returns primaryMessage and supports filterCoordinatorMessages option (default true).","created_at":"2026-01-27T17:11:49.207Z","tags":"opencode,smart-voice-notify,rich-context,idle-events"}
{"id":"mem-8134131580c6099e","information":"VoiceOrchestrator tests: timeout callbacks call async trigger without await; in tests, call timer.fn then await a tick to observe state change. Orchestrator schedules timeouts when entry.timeoutMs/timeoutAt present and clears timeout on explicit trigger.","created_at":"2026-01-27T00:11:50.853Z","tags":"opencode,smart-voice-notify,voice-orchestrator,tests"}
{"id":"mem-858e1262bc22df0e","information":"workflow_bundle!: entrypoint! parsing expects braced tokens inside macro tokens, so call it as entrypoint!({ ... }); (not entrypoint! { ... };) to satisfy braced! parse. Also, #[node] register helper always uses NodeRegistry::register_fn; streaming nodes with Stream outputs need a workaround (e.g., wrapper Stream type implementing Serialize+Sync or custom register helper) until macro supports register_stream_fn.","created_at":"2026-01-27T00:52:44.983Z","tags":"dag-macros,workflow_bundle,entrypoint,streaming"}
{"id":"mem-85bcc0247174ab3c","information":"Updated rich prompt to include HARD RULES and FINAL_ASSISTANT_MESSAGE primary source, with TASK_HINT/CHANGE_STATS labels and schema re-export from rich-schema.js.","created_at":"2026-01-27T17:15:18.452Z","tags":"opencode,smart-voice-notify,rich-prompt,prompt-template"}
{"id":"mem-8bea1e89005dab8f","information":"FlowBundle allowlist enforcement wired via FlowBundle::executor calling validate_allowlist (panics on BundleError::UnknownIdentifier with clear message); added unit tests in host-inproc for executor and allowlist behavior.","created_at":"2026-01-27T06:47:15.471Z","tags":"flowbundle,host-inproc,allowlist,executor,tests"}
{"id":"mem-93ab9b25aacea16e","information":"E6 MCP Tool Surface Alignment checks: `status`/`history` are the only query tools in `agents-rs/crates/agents-mcp/src/server/tools/mod.rs`; no `server.status` or `context.peek` in active code/docs (only in `agents-rs/docs/archived/IMPL_PLAN.md`). TECHNICAL_DESIGN includes caller vs subagent context bridging section with inherit/share modes.","created_at":"2026-01-27T00:49:13.721Z","tags":"agents-rs,mcp,tools,docs,E6"}
{"id":"mem-950bb1c12d996c64","information":"Added rich voiceText validation/repair/fallback: new util/rich-validator.js with banned patterns, repair prompt, fallback builder; generateRichNotification now validates voiceText, runs one repair using minimal schema, falls back if still invalid, with debug logging.","created_at":"2026-01-27T17:17:54.590Z","tags":"opencode,smart-voice-notify,rich-notify,validation"}
{"id":"mem-96254d6aebb30883","information":"ACP adapter already exists in agents-rs/crates/agent-runtime/src/acp_server.rs with initialize/new_session/prompt, basic session map, run metadata for mcp/cwd/permission options, and limited event->session updates. Missing: context_id aggregation across runs, load_session history replay, full kernel event streaming, approval hook integration, and ACP proxy chain config.","created_at":"2026-01-27T00:49:05.909Z","tags":"acp,e4,tickets,agent-runtime"}
{"id":"mem-9b8785fa26e72eeb","information":"Cross-epic coherency review updated ticket dependencies: E2-T1/E2-T2 depend on E2-T3; E2-T4 depends on E2-T1/E2-T2/E2-T3; E4 tickets now specify ticket-level deps (E4-T1 base, E4-T2 depends on E8-T3 history_length); E8-T2 depends on E5-T3; E5-T5 scope narrowed to run-only pagination to avoid overlap with E3-T2 session summary.","created_at":"2026-01-27T01:01:17.223Z","tags":"agents-rs,tickets,dependencies,coherency,E2,E4,E5,E8"}
{"id":"mem-a95e97d076dab66e","information":"E8 artifact/history review: kernel EventKind has no artifact event; A2A artifacts are synthesized from assistant ToolResult parts in a2a-server mapping. A2A types/event bus support TaskArtifactUpdateEvent but nothing emits it. history_length appears stored in run metadata (protocols.a2a.history_length) and applied per-run via SessionPolicy, but no cross-run aggregation enforcement yet (context aggregation still missing).","created_at":"2026-01-27T00:51:00.832Z","tags":"agents-rs,E8,artifacts,history_length,a2a,kernel"}
{"id":"mem-aa4308e55f29de62","information":"Added bun test preload stub for node-notifier to avoid missing dependency in opencode-smart-voice-notify tests. After stubbing, rich-notifications.e2e still fails because rich pipeline not invoked (global fetch not called, TTS immediate), indicating unrelated config/logic issue.","created_at":"2026-01-27T00:33:31.854Z","tags":"opencode,smart-voice-notify,tests,node-notifier,bun"}
{"id":"mem-ad012cf12ffd13ea","information":"Example validation: flows-cli `run local` uses `--bind` (not `--resource`) for capability bindings; streaming examples require `--stream` or CLI errors. s5_unsupported_surface CLI prints message without explicit CTRL901 code in stderr unless host envelope is surfaced; host-web tests confirm CTRL901 mapping.","created_at":"2026-01-27T18:12:22.407Z","tags":"examples flows-cli bindings stream ctrl901 qa"}
{"id":"mem-b1ff1fad9aa1f24d","information":"In rich-prompt.js, avoid [object Object] in FINAL_ASSISTANT_MESSAGE by extracting message text from parts/content/info.content and fallback; remove duplicate DEFAULT INSTRUCTIONS and keep event guidance separately; add phrasing rules in HARD RULES to avoid passive completion phrasing.","created_at":"2026-01-27T17:30:40.331Z","tags":"opencode,smart-voice-notify,rich-prompt,voiceText,prompt-template"}
{"id":"mem-b94ad8963aa5d158","information":"Epic 01.x FlowBundle implementation pattern for lattice-flow:\n\n1. **Crate hierarchy matters**: FlowBundle/NodeResolver must live in host-inproc (not dag-core) because NodeResolver returns Arc&lt;dyn NodeHandler&gt; which is defined in kernel-exec. dag-core cannot depend on kernel-exec without circular deps.\n\n2. **kernel-exec visibility**: NodeHandler trait and NodeRegistry::handler() must be public for external crates to implement NodeResolver.\n\n3. **workflow_bundle! macro pattern**: Generates flow(), validated_ir(), bundle(). The macro derives register function paths from `*_node_spec()` calls by stripping the suffix and adding `_register`.\n\n4. **Streaming nodes need custom handling**: The #[node] macro emits `_register()` that calls register_fn, but streaming nodes need register_stream_fn. Create wrapper spec/register functions for streaming nodes.\n\n5. **Custom flow modifications**: For examples that modify FlowIR after macro generation (s5, s6), use a `bundle_def` inner module pattern - call bundle_def::flow(), modify, then wrap in custom bundle() that overrides validated_ir.","created_at":"2026-01-27T00:58:28.564Z","tags":"lattice-flow,FlowBundle,workflow_bundle,epic-01.x,architecture,proc-macro"}
{"id":"mem-b9893872fb75b9a9","information":"Resolved rich notification decisions for opencode-smart-voice-notify: use experimental.richNotifications.triggers.attentionTimeoutSeconds (0 immediate, null/undefined wait indefinitely, >0 wait N seconds); add experimental.richNotifications.apiKey/endpoint with env fallback (OPENCODE_RICH_NOTIFY_API_KEY/ENDPOINT) before aiApiKey/aiEndpoint; Phase 1 events scope is ['idle']; TTS audio pre-generated and cached with voiceText + audio.localPath; VoiceOrchestrator handles single-play with CAS trigger precedence, FIFO multi-session (max 10), /catchup plays all; rich notifications replace reminder system when enabled.","created_at":"2026-01-27T00:00:18.341Z","tags":"opencode,smart-voice-notify,implementation-plan,decisions"}
{"id":"mem-d538fbb10a1cc693","information":"In opencode-smart-voice-notify idle flow, generic desktop notify can be skipped when rich notifications are enabled; rich desktop messages should use richContent.desktopTitle/body (or voiceText fallback) and respect focus suppression.","created_at":"2026-01-27T17:34:46.248Z","tags":"opencode,smart-voice-notify,rich-notify,desktop,behavior"}
{"id":"mem-eb7d1103abe44f53","information":"Added rich AI pipeline utilities for opencode-smart-voice-notify: fetchContext collects session/messages/tools with context budget truncation; buildSchema provides notification fields; buildPrompt formats session/tool/message context; structured generator wraps schema in OpenRouter json_schema response_format with 10s timeout and JSON parsing.","created_at":"2026-01-27T00:11:00.067Z","tags":"opencode,smart-voice-notify,ai-pipeline,openrouter,json-schema"}
{"id":"mem-eebb120cd2cb6c19","information":"E5-E8 verification: kernel storage has EventStore/RunStore/BlobStore + DefaultRunRepository, SQLx only implements EventStore/RunStore (no BlobStore), filesystem backend implemented with atomic writes; no StorageBackend trait/factory. A2A streaming implemented in agents-mcp client + server tools with StreamNotifier. Push notifications explicitly deferred in TECHNICAL_DESIGN + A2A error -32003 mapping. Kernel EventKind has no artifact events; a2a-server mapping synthesizes artifacts from tool results; no ArtifactStore. history_length not enforced in a2a-server runtime/mapping beyond session policy.","created_at":"2026-01-27T01:00:26.138Z","tags":"agents-rs E5 E7 E8 storage streaming artifacts history_length"}
{"id":"mem-f0d336ca694b740c","information":"E2 verification: A2A runtime rehydrates missing runs in resume/get/cancel via RunRepository::rebuild, but stream_task still requires in-memory run and stream buffer state is not rebuilt. A2A projection determinism test exists (projection_rebuild.rs). ACP get_session rebuilds runs and restores acp_cwd/acp_mcp_servers and permission options; pending_run only for waiting states. ACP session mode/model metadata stored on new_session is not restored on rehydrate. Protocol metadata envelope still ad-hoc: Run.metadata may include protocols, mapping reads protocols.a2a or a2a fallback, ACP uses acp_* keys; RunEvent has no metadata field.","created_at":"2026-01-27T00:59:11.462Z","tags":"E2,a2a,acp,hydration,RunRepository,projection,metadata"}
{"id":"mem-f2ceef7159d2cc3e","information":"E1 verification: RunStore only has list_runs without ordering; InMemory/FileSystem/Sqlx list_runs do not sort and Sqlx query lacks ORDER BY. SessionPolicy exists and executor applies select_context/compact per-run only; no aggregation across runs or context_id helper in RunRepository. a2a-server runtime seeds only from ContextPack::Inherit and prepends ContextPack::Share transcript; no aggregated context seeding for existing context_id. agents-mcp has contexts.client_session_id but no binding lookup API; ServerState has no binding map. Tests in agents-mcp focus on send_message/send_task, no continuation/aggregation/binding tests.","created_at":"2026-01-27T00:59:22.545Z","tags":"E1,agents-rs,kernel,RunStore,SessionPolicy,a2a-server,agents-mcp,context_id,tests"}
{"id":"mem-f801dde173dc9a43","information":"Added util/rich-config.js with defaults from implementation plan and credential precedence (rich config -> env -> base ai config), plus tests covering defaults, overrides, and enablement checks.","created_at":"2026-01-27T00:08:18.058Z","tags":"opencode,rich-config,credentials,tests"}
{"id":"mem-f9e348d419e638aa","information":"Running bun e2e tests for opencode-smart-voice-notify fails with missing dependency: Cannot find package 'node-notifier' from util/desktop-notify.js. Environment lacks node-notifier; tests need stub or dependency install.","created_at":"2026-01-27T00:25:53.155Z","tags":"opencode,smart-voice-notify,tests,dependency,node-notifier"}